name: Process Images

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  # Pull Request ìƒì„± ì‹œ
  pull_request:
    branches: [ main ]
    paths:
      - 'content/**/*.md'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Custom commit message'
        required: false
        default: 'feat: ì´ë¯¸ì§€ ìë™ ì²˜ë¦¬ ë° ê²½ë¡œ ì—…ë°ì´íŠ¸'

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pull-requests: write

jobs:
  process-images:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ì»¤ë°‹ì„ ìœ„í•´ í•„ìš”)
        fetch-depth: 0
        # í† í° ì„¤ì •ìœ¼ë¡œ ì»¤ë°‹ ê¶Œí•œ í™•ë³´
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Node.js í™˜ê²½ ì„¤ì •
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # 3. ì˜ì¡´ì„± ì„¤ì¹˜ (í•„ìš”í•œ ê²½ìš°)
    - name: Install dependencies
      run: |
        # ìŠ¤í¬ë¦½íŠ¸ê°€ ì¶”ê°€ ì˜ì¡´ì„±ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ
        # npm install

    # 4. public/images/posts ë””ë ‰í† ë¦¬ ìƒì„±
    - name: Create images directory
      run: |
        mkdir -p public/images/posts

    # 5. ì´ë¯¸ì§€ ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: Process images
      id: process
      run: |
        # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        chmod +x scripts/upload-images.js
        
        # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜
        echo "SCRIPT_OUTPUT<<EOF" >> $GITHUB_OUTPUT
        node scripts/upload-images.js 2>&1 | tee process_output.log
        echo "EOF" >> $GITHUB_OUTPUT
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --quiet && git diff --cached --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    # 6. ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
    - name: Commit changes
      if: steps.process.outputs.has_changes == 'true'
      run: |
        # Git ì‚¬ìš©ì ì •ë³´ ì„¤ì •
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë³€ê²½ì‚¬í•­ ì¶”ê°€
        git add .
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        COMMIT_MSG="${{ github.event.inputs.commit_message }}"
        if [ -z "$COMMIT_MSG" ]; then
          COMMIT_MSG="feat: ì´ë¯¸ì§€ ìë™ ì²˜ë¦¬ ë° ê²½ë¡œ ì—…ë°ì´íŠ¸

ğŸ¤– Generated with GitHub Actions

Co-Authored-By: GitHub Actions <action@github.com>"
        fi
        
        # ì»¤ë°‹ ì‹¤í–‰
        git commit -m "$COMMIT_MSG"

    # 7. Pull Requestì¸ ê²½ìš° ë³€ê²½ì‚¬í•­ì„ PR ë¸Œëœì¹˜ì— í‘¸ì‹œ
    - name: Push changes to PR branch
      if: steps.process.outputs.has_changes == 'true' && github.event_name == 'pull_request'
      run: |
        git push origin HEAD:${{ github.head_ref }}

    # 8. ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš° main ë¸Œëœì¹˜ì— í‘¸ì‹œ
    - name: Push changes to main
      if: steps.process.outputs.has_changes == 'true' && github.event_name == 'workflow_dispatch'
      run: |
        git push origin main

    # 9. ì²˜ë¦¬ ê²°ê³¼ ìš”ì•½ ìƒì„±
    - name: Create summary
      if: always()
      run: |
        echo "## ğŸ–¼ï¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.process.outputs.has_changes }}" == "true" ]; then
          echo "âœ… **ì´ë¯¸ì§€ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë³€ê²½ì‚¬í•­:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 HEAD | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **ì²˜ë¦¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ìŠ¤í¬ë¦½íŠ¸ ì¶œë ¥ ë¡œê·¸:" >> $GITHUB_STEP_SUMMARY
        echo '<details><summary>ë¡œê·¸ ë³´ê¸°</summary>' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat process_output.log >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo '</details>' >> $GITHUB_STEP_SUMMARY

    # 10. PRì— ì½”ë©˜íŠ¸ ì¶”ê°€ (Pull Requestì¸ ê²½ìš°)
    - name: Comment on PR
      if: steps.process.outputs.has_changes == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `## ğŸ–¼ï¸ ì´ë¯¸ì§€ ìë™ ì²˜ë¦¬ ì™„ë£Œ!
          
          ì´ PRì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì—ì„œ ë¡œì»¬ ì´ë¯¸ì§€ ì°¸ì¡°ë¥¼ ê°ì§€í•˜ì—¬ ìë™ìœ¼ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.
          
          ### ë³€ê²½ì‚¬í•­:
          - ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ \`public/images/posts/\` ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          - ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì˜ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì—…ë°ì´íŠ¸
          - ì´ë¯¸ì§€ íŒŒì¼ëª…ì„ ì•ˆì „í•œ í˜•ì‹ìœ¼ë¡œ ë³€ê²½
          
          ### ì²˜ë¦¬ëœ íŒŒì¼:
          \`\`\`
          ${{ steps.process.outputs.SCRIPT_OUTPUT }}
          \`\`\`
          
          ğŸ¤– *ì´ ì‘ì—…ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });